import {Component, OnInit} from '@angular/core';
import {Report} from '../report';
import {ReportService} from '../report.service';
import {VulnCounter} from '../VulnCounter';

@Component({
    selector: 'app-reports',
    templateUrl: './reports.component.html',
    styleUrls: ['./reports.component.css']
})
export class ReportsComponent implements OnInit {

    constructor(private reportService: ReportService) {
    }

    vulnsMap: { report: Report, vulnCount: VulnCounter[] }[];

    countVulns(reports: Report[]) {
        this.vulnsMap = [];
        const tempVulnsMap = this.vulnsMap;
        reports.forEach(function (report) {
            tempVulnsMap.push({report: report, vulnCount: []});
            const reportIndex = tempVulnsMap.findIndex(function (reportVulns) {
                return reportVulns.report.id === report.id;
            });

            const vulnsCounter = tempVulnsMap[reportIndex].vulnCount;

            report.vulns.forEach(function (vuln) {
                const vulnIndex = vulnsCounter.findIndex(function (counter) {
                    return vuln.impactLevel.id === counter.impactId;
                });
                if (vulnIndex >= 0) {
                    vulnsCounter[vulnIndex].count = vulnsCounter[vulnIndex].count + 1;
                } else {
                    vulnsCounter.push({impactId: vuln.impactLevel.id, count: 1});
                }
            });
            vulnsCounter.sort((n1, n2) => n1.impactId - n2.impactId);
        });
    }

    ngOnInit() {
        this.reportService.getReports()
            .subscribe(reports => this.countVulns(reports));
    }
}
